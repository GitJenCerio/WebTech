# Firebase to MongoDB Migration Guide

This guide will help you migrate your client/customer data from Firebase Firestore to MongoDB.

## üìã Prerequisites

- Node.js (v14 or higher)
- Access to your Firebase project
- MongoDB database (local or Atlas)
- Firebase service account key

## üöÄ Quick Start

### 1. Install Dependencies

```bash
npm install firebase-admin mongoose dotenv
```

### 2. Set Up Firebase Authentication

**You have two options - use either METHOD A (recommended) OR METHOD B:**

#### METHOD A: Environment Variables (Recommended) ‚úÖ

Your Firebase credentials are already configured in `scripts/.env`! No additional setup needed for Firebase.

This method is more secure than storing a JSON file and the credentials are:
- ‚úÖ Already configured
- ‚úÖ Project ID: `glammednailsbyjhen-1345c`
- ‚úÖ Using service account

#### METHOD B: Service Account JSON File (Alternative)

If you prefer to use a JSON file instead:

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Click on **Project Settings** (gear icon)
4. Go to **Service Accounts** tab
5. Click **Generate New Private Key**
6. Save the downloaded JSON file as `serviceAccountKey.json` in your project root

‚ö†Ô∏è **Important**: Never commit this file to version control! Add it to `.gitignore`:

```bash
echo "serviceAccountKey.json" >> .gitignore
```

### 3. Configure MongoDB Connection

Your Firebase credentials are already set up! Now you just need to configure MongoDB:

1. Open `scripts/.env` in your editor

2. Update the `MONGODB_URI` with your actual MongoDB connection string:
   ```env
   # For local MongoDB:
   MONGODB_URI=mongodb://localhost:27017/glammednails
   
   # For MongoDB Atlas (cloud):
   MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/glammednails
   ```

3. Keep `DRY_RUN=true` for your first test run

That's it! You're ready to run the migration.

### 4. Run Dry-Run Mode (Recommended First Step)

Before migrating actual data, run in dry-run mode to preview what will be migrated:

```bash
node scripts/migrate-firebase-to-mongodb.js
```

This will:
- Show you how many documents will be migrated
- Display sample transformed documents
- Validate your configuration
- **NOT write anything to MongoDB**

### 5. Run the Migration

After verifying the dry-run looks correct:

1. Set `DRY_RUN=false` in your `.env` file
2. Run the migration:
   ```bash
   node scripts/migrate-firebase-to-mongodb.js
   ```

## üìñ Features

### ‚úÖ What the Script Does

- **Connects to both databases**: Firebase Firestore and MongoDB
- **Field mapping**: Intelligently maps Firebase fields to MongoDB schema
- **Progress tracking**: Real-time progress bar with ETA
- **Error handling**: Continues on errors and logs them separately
- **Duplicate detection**: Skips documents already migrated
- **Batch processing**: Processes documents in batches to manage memory
- **Resume capability**: Can resume from where it left off if interrupted
- **Backup creation**: Creates backup of data before migration
- **Validation**: Compares document counts after migration
- **Detailed reporting**: Generates comprehensive migration reports

### üó∫Ô∏è Field Mapping

The script maps Firebase fields to MongoDB fields as follows:

| Firebase Field | MongoDB Field | Notes |
|---------------|---------------|-------|
| `id` (document ID) | `firebaseId` | Preserved for reference |
| `name` / `fullName` | `name` | Required field |
| `firstName` | `firstName` | Optional |
| `lastName` | `lastName` | Optional |
| `email` | `email` | Lowercase, trimmed |
| `phone` / `phoneNumber` / `mobile` | `phone` | Optional |
| `socialMediaName` / `socialMedia` / `instagram` | `socialMediaName` | Optional |
| `referralSource` / `howDidYouHear` / `source` | `referralSource` | Optional |
| `isRepeatClient` / `returning` / `repeat` | `isRepeatClient` | Defaults to false |
| `notes` / `comments` / `additionalInfo` | `notes` | Optional |
| `createdAt` | `originalCreatedAt` | Preserved timestamp |
| - | `migratedAt` | New field, timestamp of migration |
| - | `createdAt`, `updatedAt` | Auto-generated by Mongoose |

**Note**: If your Firebase has different field names, you can modify the `transformDocument()` function in the script.

## üîß Advanced Usage

### Resume Interrupted Migration

If the migration is interrupted, simply run the script again. It will automatically resume from where it left off using the checkpoint file.

### Rollback Migration

If you need to remove all migrated documents from MongoDB:

```bash
node scripts/migrate-firebase-to-mongodb.js --rollback
```

‚ö†Ô∏è **Warning**: This will delete ALL documents from the MongoDB customers collection!

### Custom Batch Size

If you experience memory issues, reduce the batch size:

```env
BATCH_SIZE=50
```

For faster migration (if you have sufficient memory):

```env
BATCH_SIZE=500
```

### View Migration Progress

The script displays real-time progress:
- Current document number and total
- Successful migrations (‚úì)
- Failed migrations (‚úó)
- Skipped migrations (‚äò)
- Processing rate (docs/second)
- Estimated time remaining (ETA)

## üìä Output Files

After running the migration, you'll find the following files:

### `migration-report.json`
Complete migration statistics including:
- Timestamp
- Configuration used
- Summary stats (total, successful, failed, skipped)
- Document counts from both databases
- Validation results
- Sample transformed documents (in dry-run mode)

### `migration-errors.log`
Detailed error logs for any failed migrations, including:
- Timestamp
- Document ID
- Error message and stack trace
- Original document data

### `migration-backup.json`
Complete backup of all Firebase documents before migration (in live mode only)

### `migration-checkpoint.json`
Checkpoint file for resume capability (automatically deleted after successful completion)

## üõ†Ô∏è Troubleshooting

### Error: "Service account key not found"

**Solution**: Make sure `serviceAccountKey.json` is in the project root directory.

```bash
# Check if file exists
dir serviceAccountKey.json
```

### Error: "MONGODB_URI environment variable is not set"

**Solution**: Make sure you have a `.env` file in the `scripts` directory with `MONGODB_URI` set.

```bash
# Check if .env exists
dir scripts\.env
```

### Error: "Duplicate key error"

**Solution**: This means some documents were already migrated. The script will skip them automatically. This is normal if you're re-running the migration.

### Migration is slow

**Solutions**:
1. Increase `BATCH_SIZE` in `.env` (e.g., `BATCH_SIZE=200`)
2. Check your network connection to both databases
3. Check your MongoDB and Firebase database performance

### Out of memory errors

**Solution**: Reduce `BATCH_SIZE` in `.env` (e.g., `BATCH_SIZE=25`)

## üîí Security Best Practices

1. **Never commit sensitive files**:
   - `serviceAccountKey.json`
   - `.env`
   - `migration-backup.json`

2. **Add to `.gitignore`**:
   ```gitignore
   serviceAccountKey.json
   scripts/.env
   scripts/migration-*.json
   scripts/migration-*.log
   ```

3. **Secure MongoDB connection**:
   - Use strong passwords
   - Enable IP whitelist in MongoDB Atlas
   - Use environment variables for credentials

4. **Delete service account key after migration**:
   ```bash
   del serviceAccountKey.json
   ```

## üìù Example Run

```bash
$ node scripts/migrate-firebase-to-mongodb.js

================================================================================
   FIREBASE TO MONGODB MIGRATION SCRIPT
================================================================================

[2026-02-08T10:30:00.000Z] [SUCCESS] Firebase Admin SDK initialized successfully
[2026-02-08T10:30:01.000Z] [SUCCESS] MongoDB connected successfully
[2026-02-08T10:30:01.000Z] [INFO] Starting migration process...
[2026-02-08T10:30:01.000Z] [INFO] Mode: LIVE
[2026-02-08T10:30:01.000Z] [INFO] Batch size: 100
[2026-02-08T10:30:02.000Z] [INFO] Fetching documents from Firebase...
[2026-02-08T10:30:03.000Z] [INFO] Found 250 documents in Firebase clients collection
[2026-02-08T10:30:03.000Z] [INFO] Creating backup...
[2026-02-08T10:30:04.000Z] [SUCCESS] Backup saved to ./migration-backup.json

Progress: 250/250 (100.00%) | ‚úì 245 | ‚úó 2 | ‚äò 3 | 12.5 docs/s | ETA: 0s

[2026-02-08T10:30:24.000Z] [SUCCESS] Migration completed!
[2026-02-08T10:30:24.000Z] [INFO] Validating migration...
[2026-02-08T10:30:25.000Z] [INFO] Firebase documents: 250
[2026-02-08T10:30:25.000Z] [INFO] MongoDB documents: 248
[2026-02-08T10:30:25.000Z] [SUCCESS] Validation passed ‚úì
[2026-02-08T10:30:25.000Z] [SUCCESS] Report saved to ./migration-report.json

================================================================================
   MIGRATION SUMMARY
================================================================================
Mode:           LIVE
Total:          250
Processed:      250
Successful:     245
Failed:         2
Skipped:        3
Duration:       20.00s
Rate:           12.5 docs/s
================================================================================

[2026-02-08T10:30:25.000Z] [SUCCESS] Migration script completed successfully
```

## üÜò Support

If you encounter issues:

1. Check the `migration-errors.log` file for detailed error messages
2. Review the `migration-report.json` for statistics
3. Ensure both Firebase and MongoDB are accessible
4. Verify your service account key has proper permissions
5. Check that MongoDB URI is correct

## üìÑ License

This migration script is part of your project and follows the same license.
